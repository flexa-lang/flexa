using flx.core.console;

// --------------------------------------------------
// TicTacToe game class
// --------------------------------------------------
class TicTacToe {
	const BOARD_SIZE;
    var board: int[3][3];
    var current_player: int;
    var game_over: bool;
    var winner: int;

    // Constructor
    init() {
		BOARD_SIZE = 3;
        self.reset();
    }
	
    init(size) {
		BOARD_SIZE = size;
        self.reset();
    }

    // Reset the game state
    fun reset() {
        for (var row = 0; row < BOARD_SIZE; row++) {
            for (var col = 0; col < BOARD_SIZE; col++) {
                self.board[row][col] = 0;
            }
        }

        self.current_player = 1; // 1 = X, 2 = O
        self.game_over = false;
        self.winner = 0;
    }

    // Main game loop
    fun run() {
        println("=== Tic-Tac-Toe (Console) ===");

        while (not self.game_over) {
            self.print_board();
            self.print_turn_info();
            self.handle_input();
            self.update_game_state();
        }

        self.print_board();
        self.print_result();
    }

    // Print the current board state
    fun print_board() {
        println("");

        for (var row = 0; row < BOARD_SIZE; row++) {
            var line = "";

            for (var col = 0; col < BOARD_SIZE; col++) {
                var cell = self.board[row][col];

                if (cell == 1) {
                    line += " X ";
                }
                else if (cell == 2) {
                    line += " O ";
                }
                else {
                    line += " . ";
                }

                if (col < BOARD_SIZE - 1) {
                    line += "|";
                }
            }

            println(line);

            if (row < BOARD_SIZE - 1) {
                println("---+---+---");
            }
        }

        println("");
    }

    // Print whose turn it is
    fun print_turn_info() {
        var player = self.current_player == 1 ? "X" : "O";
        println("Current player: " + player);
        println("Enter row and column (0-2), separated by space:");
    }

    // Handle user input
    fun handle_input() {
        while (true) {
            var input = read();
            var parts = input.split(" ");

            if (parts.size() != 2) {
                println("Invalid input. Use: row col");
                continue;
            }

            var row = parts[0].to_int();
            var col = parts[1].to_int();

            if (row < 0 or row >= BOARD_SIZE or col < 0 or col >= BOARD_SIZE) {
                println("Coordinates out of range. Try again.");
                continue;
            }

            if (self.board[row][col] != 0) {
                println("Cell already occupied. Try again.");
                continue;
            }

            self.board[row][col] = self.current_player;
            break;
        }
    }

    // Update the game state after a move
    fun update_game_state() {
        if (self.check_winner()) {
            self.game_over = true;
            self.winner = self.current_player;
            return;
        }

        if (self.is_draw()) {
            self.game_over = true;
            self.winner = 0;
            return;
        }

        self.switch_player();
    }

    // Switch between players
    fun switch_player() {
        self.current_player = self.current_player == 1 ? 2 : 1;
    }

    // Check if the current player won
    fun check_winner(): bool {
        // Rows
        for (var i = 0; i < 3; i++) {
            if (self.board[i][0] != 0 and
                self.board[i][0] == self.board[i][1] and
                self.board[i][1] == self.board[i][2]) {
                return true;
            }
        }

        // Columns
        for (var j = 0; j < 3; j++) {
            if (self.board[0][j] != 0 and
                self.board[0][j] == self.board[1][j] and
                self.board[1][j] == self.board[2][j]) {
                return true;
            }
        }

        // Diagonals
        if (self.board[0][0] != 0 and
            self.board[0][0] == self.board[1][1] and
            self.board[1][1] == self.board[2][2]) {
            return true;
        }

        if (self.board[0][2] != 0 and
            self.board[0][2] == self.board[1][1] and
            self.board[1][1] == self.board[2][0]) {
            return true;
        }

        return false;
    }

    // Check if the board is full
    fun is_draw(): bool {
        for (var row = 0; row < 3; row++) {
            for (var col = 0; col < 3; col++) {
                if (self.board[row][col] == 0) {
                    return false;
                }
            }
        }
        return true;
    }

    // Print the final result
    fun print_result() {
        if (self.winner == 0) {
            println("Game ended in a draw.");
        }
        else {
            var player = self.winner == 1 ? "X" : "O";
            println("Player " + player + " wins!");
        }
    }
}

// --------------------------------------------------
// Main entry point
// --------------------------------------------------
fun main() {
    var game = TicTacToe();
    game.run();
}

main();
